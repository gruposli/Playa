<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Playa & Cargas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Dark por defecto */
      --bg:#0f172a; --ink:#e5e7eb; --muted:#9aa5b1;
      --card:#0b1220; --card-b:#2b3647; --chip:#142031;

      --rowb:#3b4758;
      --thead-bg:#132137; --thead-b:#6b7280;
      --btn:#1d4ed8; --btn-ink:#e5e7eb;
      --badge-bg:#1c2a40; --badge-ink:#d1d5db;

      --tbl-font:22px; --h3-font:30px; --badge-font:18px; --thick:4px;

      /* Colores de ETAPA (AsignaciÃ³n / Inicio / Fin) */
      --stage1-bg:#f59e0b;  --stage1-ink:#111827; /* AsignaciÃ³n */
      --stage2-bg:#06b6d4;  --stage2-ink:#05202a; /* Inicio */
      --stage3-bg:#8b5cf6;  --stage3-ink:#0c0520; /* Fin   */
    }
    .light{
      --bg:#eef3f8; --ink:#0b1220; --muted:#4b5563;
      --card:#ffffff; --card-b:#8a97ab; --chip:#e7eef7;
      --rowb:#5c6777; --thead-bg:#e5edf7; --thead-b:#334155;
      --btn:#0ea5e9; --btn-ink:#ffffff; --badge-bg:#e7eef7; --badge-ink:#111827;
    }

    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:20px;background:var(--bg);color:var(--ink)}
    /* --- MODO FULLSCREEN (ocultar chrome propio y mÃ¡rgenes) --- */
    body.is-fs{ margin:0; }
    body.is-fs .header{ display:none; }

    .header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .btn{background:var(--btn);border:0;color:var(--btn-ink);border-radius:14px;padding:14px 18px;font-weight:900;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.15);font-size:18px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    label{font-size:18px}
    .muted{color:var(--muted)}

    .card{background:var(--card);border:var(--thick) solid var(--card-b);border-radius:18px;box-shadow:0 6px 14px rgba(0,0,0,.14)}
    .card h3{margin:0;padding:18px 20px;border-bottom:var(--thick) solid var(--thead-b);font-size:var(--h3-font);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .h3-count{font-size:var(--badge-font);font-weight:900;background:var(--badge-bg);color:var(--badge-ink);border-radius:999px;padding:6px 12px;border:3px solid var(--rowb)}
    .card .body{padding:16px 18px}

    .table-wrap{overflow-x:auto}
    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      font-size:var(--tbl-font);
      min-width:980px; /* â†“ mÃ¡s amigable en mÃ³vil */
    }
    th,td{padding:16px 14px;border-bottom:var(--thick) solid var(--rowb);text-align:left;white-space:nowrap}
    th{background:var(--thead-bg);font-weight:1000;color:var(--ink);border-bottom:calc(var(--thick) + 1px) solid var(--thead-b);position:sticky; top:0; z-index:1}

  /* ===== Layout mitad/mitad (50/50) con orden en mobile ===== */
.main-grid{
  display:grid;
  grid-template-areas: "table planta";
  /* ANTES: grid-template-columns: 1fr 1fr;  50/50 */
  grid-template-columns: 48% 52%; /* AHORA: 40% izquierda / 60% derecha */
  gap:20px; margin-top:20px;
}
    .card-left  { grid-area: table; }
    .card-right { grid-area: planta; }

    /* En mobile: primero EN PLANTA, luego la tabla */
    @media (max-width: 900px){
      .main-grid{
        grid-template-areas:
          "planta"
          "table";
        grid-template-columns: 1fr;
      }
      :root{ --tbl-font: 18px; } /* opcional: reducir tipografÃ­a de tabla */
    }

    /* ===== EN PLANTA (derecha) ===== */
    /* Columna 1 (combo PRESENTADO/PLAYA/PLAY2) mÃ¡s ancha */
    .planta-grid{
      display:grid;
      grid-template-columns: minmax(520px, 30%) 1fr; /* ðŸ‘ˆ combo ~55% */
      gap:16px;
    }
    @media (max-width: 1200px){ .planta-grid{ grid-template-columns: 1fr; } }

    .planta-rest{display:grid;grid-template-columns: repeat(2, minmax(320px,1fr));gap:16px}
    @media (max-width: 700px){ .planta-rest{ grid-template-columns: 1fr; } }

    .planta-col{background:var(--card);border:var(--thick) solid var(--card-b);border-radius:16px}
    .planta-col h4{
      margin:0;padding:14px 16px;border-bottom:var(--thick) solid var(--thead-b);
      font-size:24px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    }
    /* Forzar 1 lÃ­nea en el tÃ­tulo del combo (ellipsis si no entra) */
    .planta-col.combo h4{
      flex-wrap: nowrap;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      gap: 18px;
    }
    .badge{font-size:20px;background:var(--badge-bg);color:var(--badge-ink);border-radius:999px;padding:6px 12px;font-weight:1000;border:3px solid var(--rowb)}
    .planta-col .list{padding:12px 14px;min-height:64px}

    /* ===== CHIP (globo) â€“ MÃS GRANDE ===== */
    .chip{
      display:flex;flex-direction:column;align-items:flex-start;
      background:var(--chip);border-radius:20px;
      padding:22px 26px;                 /* â†‘ padding */
      font-size: clamp(22px, 2.1vw, 30px);/* â†‘ texto principal */
      margin:12px 0;gap:12px;
      border:var(--thick) solid #00000022
    }
    .chip .line0{ font-size: clamp(18px, 1.6vw, 22px); font-weight:1000 }
    .chip .line1{ display:flex; gap:14px; align-items:center; font-weight:1000; }
    .chip .line2{ opacity:.98; font-weight:900; font-size: clamp(18px, 1.8vw, 22px); }
    .chip .sep{ opacity:.7 }

    /* Pastilla del evento mÃ¡s grande */
    .chip .line2 .stage-pill{
      display:inline-flex;
      align-items:center;
      padding:10px 14px;
      border-radius:16px;
      border: 2px solid rgba(0,0,0,.18);
      background-color: var(--stage-bg, #06b6d4) !important;
      color:           var(--stage-ink, #05202a) !important;
      animation: blinkSync 1.25s ease-in-out infinite;
    }

    /* CronÃ³metro del globo un poco mÃ¡s grande */
    .ago-badge{
      display:inline-flex; align-items:center;
      padding:8px 12px; border-radius:14px;
      margin-left:.6ch; font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,.12); color: var(--ink); border: 1px solid rgba(0,0,0,.25);
      font-size: clamp(14px, 1.5vw, 20px);
    }
    .ago-badge.overdue{ background:#ef4444 !important; color:#ffffff !important; border-color:#7f1d1d !important; }

    /* --- Fila EN PLANTA por dÃ¡rsena (genÃ©rico) --- */
    tr.dock-row td{
      background:var(--dock-bg) !important;
      color:var(--dock-ink) !important;
      border-color:rgba(0,0,0,.22);
    }
    /* --- OVERRIDE: SituaciÃ³n en EN PLANTA usa color de ETAPA --- */
    tr.dock-row td.stage-situ{
      background:var(--stage-bg) !important;
      color:var(--stage-ink) !important;
      border-color:rgba(255,255,255,.25) !important;
      animation: blinkSync 1.25s ease-in-out infinite;
    }

    /* SituaciÃ³n (Ingresos/Salidas) por estado */
    td.td-situ{font-weight:1000;text-align:center;border:var(--thick) solid var(--rowb);border-radius:12px}
    td.situ-ok   {background:#22c55e;color:#06140b;border-color:#14532d}
    td.situ-late {background:#ef4444;color:#3b0a0a;border-color:#7f1d1d}
    td.situ-info {background:#60a5fa;color:#0b214a;border-color:#1e40af}
    td.situ-neut {background:#cbd5e1;color:#0b1220;border-color:#64748b}

    /* AnimaciÃ³n sincronizada (blink) */
    @keyframes blinkSync {
      0%,100% { filter: brightness(0.96); box-shadow: 0 0 0 rgba(255,255,255,0); }
      50%     { filter: brightness(1.22); box-shadow: 0 0 12px rgba(255,255,255,0.18); }
    }

    /* En planta: tÃ­tulo y contador GRANDES */
    .h3-planta{ font-size: clamp(36px, 3.8vw, 64px); gap: 16px; }
    #countPlanta{ font-size: clamp(28px, 3.2vw, 48px); padding: 10px 16px; border-width: 4px; }
    .card > h3.h3-planta{ font-size: clamp(40px, 4.2vw, 68px) !important; gap: 18px; line-height: 1.1; }
    .card > h3.h3-planta .h3-count#countPlanta{
      font-size: clamp(30px, 3.4vw, 52px) !important; padding: 12px 18px; border-width: 4px;
    }

    /* â€œActualizadoâ€ pequeÃ±o entre En planta y el reloj */
    .last-mini{
      font-size: clamp(14px, 1.4vw, 20px);
      color: var(--muted);
      font-weight: 700;
      margin-left: 8px;
      white-space: nowrap;
      align-self: center;
    }

    /* Reloj grande */
    .card > h3.h3-planta .clock-big{
      font-size: clamp(48px, 5.5vw, 96px) !important;
      font-weight: 1000;
      letter-spacing: .5px;
      margin-left: auto;
      line-height: .95;
      font-variant-numeric: tabular-nums;
      text-shadow: 0 2px 0 rgba(0,0,0,.25), 0 4px 12px rgba(0,0,0,.25);
    }
    .light .clock-big{ text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 6px 16px rgba(0,0,0,.35); }

    /* SituaciÃ³n â€“ tonos suaves SOLO para Salidas */
.sal-row .td-situ{
  font-weight:1000;
  text-align:center;
  border:var(--thick) solid var(--rowb);
  border-radius:12px;
}

/* Verde suave (A tiempo) â€“ solo salidas */
.sal-row .td-situ.situ-ok{
  background:#d5f8e1;   /* verde pastel */
  color:#065f46;        /* texto verde oscuro */
  /* border-color:#34d399; /* borde verde medio */
}

/* Rojo suave (Demorado) â€“ solo salidas */
.sal-row .td-situ.situ-late{
    background:#e5d1d1;   /* rojo pastel */
  color:#7f1d1d;        /* texto rojo oscuro */
   /* border-color:#fecaca; /* borde rojo medio */
}

/* Informativo (Programado) â€“ solo salidas */
.sal-row .td-situ.situ-info{
  background:#dbeafe;
  color:#0b214a;
  border-color:#93c5fd;
}

/* Neutro â€“ solo salidas */
.sal-row .td-situ.situ-neut{
  background:#e2e8f0;
  color:#0b1220;
  border-color:#94a3b8;
}
/* Escala por transform (fallback) */
body.scaled{
  /* --appScale se setea desde JS (0.6 = 60%) */
  transform: scale(var(--appScale, 0.6));
  transform-origin: top left;
  width: calc(100% / var(--appScale, 0.6));
  height: calc(100% / var(--appScale, 0.6));
}

/* Opcional: evita scroll si algo se desborda por rounding */
html, body{ overflow: hidden; }

  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h2 style="margin:0;font-size:34px">Playa & Cargas</h2>
    <div id="last" class="muted" style="display: none;">Actualizandoâ€¦</div>
    <div class="grow"></div>
    <button id="btn" class="btn">Actualizar</button>
    <button id="toggleTheme" class="btn" title="Alternar tema">Tema</button>
    <label><input type="checkbox" id="auto" checked> Auto-refresh 60s</label>
    <!-- NUEVO: BotÃ³n pantalla completa -->
    <button id="btnFS" class="btn" title="Pantalla completa">Pantalla completa</button>
  </div>

  <div class="main-grid">
    <!-- IZQUIERDA: Tabla Ãºnica -->
    <div class="card card-left">
      <h3>
        Ingresos esperados <span id="countIng" class="h3-count">0</span>,
        En planta <span id="countPlantaMini" class="h3-count">0</span>
        y salidas confirmadas <span id="countSal" class="h3-count">0</span>
      </h3>
      <div class="body table-wrap">
        <table id="tblMix">
          <thead>
            <tr>
              <th>HR</th><th>Patente</th><th>Hora</th><th>Estado</th>
              <th>Vuelta</th><th>Tipo</th><th>Equipo</th><th>Zona</th><th>Transporte</th>
              <th>Ingreso</th><th>Salida</th><th>SituaciÃ³n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- DERECHA: En planta (chips) -->
    <div class="card card-right">
      <h3 class="h3-planta">
        En planta <span id="countPlanta" class="h3-count">0</span>
        <span id="lastMini" class="last-mini">Actualizandoâ€¦</span>
        <span id="clockPlanta" class="clock-big">00:00:00</span>
      </h3>
      <div class="body">
        <div class="planta-grid">
          <!-- globo combinado primero -->
          <div id="plantaCombo" class="planta-col combo">
            <h4>
              PRESENTADO <span class="badge">0</span>
              PLAYA <span class="badge">0</span>
              PLAY2 <span class="badge">0</span>
            </h4>
            <div class="list"><div class="muted">â€”</div></div>
          </div>
          <!-- luego el resto -->
          <div id="plantaRest" class="planta-rest"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const JSON_URL = 'https://script.google.com/macros/s/AKfycbwW8_C7xDTOGiqda99_b5vM8lEV4WwqX78DUvx3pFG26kZ9N3_d5agZ1TbJXtUD2zcQ/exec';

  /* Colores por dÃ¡rsena (fila y chip por defecto) */
  const DOCK_COLORS = {
    'PRESENTADO': {bg:'#2a4365', ink:'#e6f0ff'},
    'PLAYA':      {bg:'#1f5e3b', ink:'#e7ffe9'},
    'PLAY2':      {bg:'#3b2f6b', ink:'#efe8ff'},
    'DOCK1':      {bg:'#6b2f2f', ink:'#ffecec'},
    'DOCK2':      {bg:'#6b4f1f', ink:'#fff2dc'},
    'DOCK3':      {bg:'#265d5d', ink:'#e8ffff'},
    'ALERO':      {bg:'#5a315d', ink:'#ffe9ff'},
    'CARPA':      {bg:'#27472f', ink:'#e9ffe9'}
  };
  const DEFAULT_DOCK = {bg:'#243b53', ink:'#e8f0ff'};
  function getDockColor(name){ return DOCK_COLORS[String(name||'').toUpperCase()] || DEFAULT_DOCK; }

  /* Colores de etapa (para SituaciÃ³n en planta + pill del chip) */
  function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
  const STAGE_STYLE = {
    1: { bg: getCSS('--stage1-bg'), ink: getCSS('--stage1-ink') }, // AsignaciÃ³n
    2: { bg: getCSS('--stage2-bg'), ink: getCSS('--stage2-ink') }, // Inicio
    3: { bg: getCSS('--stage3-bg'), ink: getCSS('--stage3-ink') }  // Fin
  };

  let timer=null;
  document.getElementById('btn').onclick = loadData;
  document.getElementById('toggleTheme').onclick = ()=>{
    const light = document.body.classList.toggle('light');
    localStorage.setItem('themeLight', light ? '1' : '0');
  };

  /* ==================== FULLSCREEN ==================== */
  const btnFS = document.getElementById('btnFS');

  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
  }

  async function enterFS(){
    const el = document.documentElement;
    try{
      if (el.requestFullscreen)      await el.requestFullscreen();
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen(); // Safari / Tizen
      else if (el.msRequestFullscreen)     await el.msRequestFullscreen();     // IE/Edge legacy
    }catch(e){ console.log('FS error', e); }
  }

  async function exitFS(){
    try{
      if (document.exitFullscreen)      await document.exitFullscreen();
      else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
      else if (document.msExitFullscreen)     await document.msExitFullscreen();
    }catch(e){ console.log('FS exit error', e); }
  }

  function updateFSUI(){
    const fs = isFullscreen();
    document.body.classList.toggle('is-fs', fs);
    if (btnFS){
      btnFS.textContent = fs ? 'Salir de pantalla completa' : 'Pantalla completa';
      btnFS.title = btnFS.textContent;
    }
  }

  btnFS?.addEventListener('click', ()=>{
    if (isFullscreen()) exitFS(); else enterFS();
  });

  // Enter (OK en control remoto) para entrar a FS; Escape/Back para salir
  document.addEventListener('keydown', (e)=>{
    const k = e.key;
    if (!isFullscreen() && (k === 'Enter' || k === 'Accept')) {
      enterFS();
    } else if (isFullscreen() && (k === 'Escape' || k === 'Backspace')) {
      exitFS();
    }
  });

  // Cambios de estado fullscreen (cubre Tizen/Safari)
  ['fullscreenchange','webkitfullscreenchange','MSFullscreenChange'].forEach(ev=>{
    document.addEventListener(ev, updateFSUI);
  });

  /* ================== FIN FULLSCREEN ================== */

  let clockTimer = null;
  function startClockPlanta(){
    if (clockTimer){ clearInterval(clockTimer); }
    const el = document.getElementById('clockPlanta');
    if (!el) return;
    const tz = 'America/Argentina/Buenos_Aires';
    const opts = { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone: tz };
    const tick = ()=>{
      try{ el.textContent = new Date().toLocaleTimeString('es-AR', opts); }
      catch(_){
        const now = new Date(); const pad = n => String(n).padStart(2,'0');
        el.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      }
    };
    tick();
    clockTimer = setInterval(tick, 1000);
  }

  document.getElementById('auto').onchange = e=>{
    if(e.target.checked){ timer=setInterval(loadData,60000); loadData(); }
    else if(timer){ clearInterval(timer); timer=null; }
  };
  (function initAutoRefresh(){
    const chk = document.getElementById('auto');
    if (chk && chk.checked){
      timer = setInterval(loadData, 60000);
    }
  })();

  async function fetchJSONLatest(){
    try{
      const r = await fetch(JSON_URL,{cache:'no-store'});
      return await r.json();
    }catch(_){
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Date.now();
        window[cb]=(d)=>{ resolve(d); cleanup(); };
        const s=document.createElement('script');
        s.src=JSON_URL+(JSON_URL.includes('?')?'&':'?')+'callback='+cb+'&_='+Date.now();
        s.onerror=(e)=>{ cleanup(); reject(e); };
        document.body.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
      });
    }
  }

  async function loadData(){
    const btn=document.getElementById('btn'); btn.disabled=true;
    try{
      const data = await fetchJSONLatest();
      if(!data || data.ok===false) throw new Error(data && data.error || 'Sin datos');
      renderAll(data);
    }catch(e){
      console.error(e);
      document.getElementById('last').textContent='Error al cargar';
      document.getElementById('lastMini').textContent='Error al cargar';
      ['countIng','countSal','countPlanta','countPlantaMini'].forEach(id=>document.getElementById(id).textContent='0');
      document.querySelector('#tblMix tbody').innerHTML='';
      document.getElementById('plantaRest').innerHTML='';
      document.getElementById('plantaCombo').querySelector('.list').innerHTML='<div class="muted">â€”</div>';
      document.getElementById('plantaCombo').querySelector('h4').innerHTML = `
        PRESENTADO <span class="badge">0</span>
        PLAYA <span class="badge">0</span>
        PLAY2 <span class="badge">0</span>`;
    }finally{ btn.disabled=false; }
  }

  function renderAll(data){
    const meta=data.meta||{};
    const ts = meta.ts_ba||meta.ts_utc||'';
    document.getElementById('last').textContent     = `Actualizado: ${ts}`;
    document.getElementById('lastMini').textContent = `Actualizado: ${ts}`;
    renderPlanta(data);
    renderTablaUnica(data);
  }

  /* ===== Estado para Ingresos/Salidas ===== */
  function situClassByEstado(estado){
    const e = String(estado||'').trim().toLowerCase();
    if (e==='a tiempo' || e==='en tiempo') return 'situ-ok';
    if (e==='demorado' || e==='demorada') return 'situ-late';
    if (e==='programado' || e==='programada') return 'situ-info';
    return 'situ-neut';
  }

  /* ===== Etapa a partir del Ãºltimo evento ===== */
  function stageFromEvent(evName){
    const e = String(evName||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase();
    if (e.includes('FIN DE CARGA'))        return 3;
    if (e.includes('INICIO DE CARGA'))     return 2;
    if (e.includes('ASIGNACION DE CARGA')) return 1;
    return 0;
  }

  /* Ãndices utilitarios */
  function buildEventIndex(movs, allowed){
    const allow = new Set((allowed||[]).map(s=>String(s).toUpperCase()));
    const idx = {};
    for(const m of movs){
      const hr = String(m.hr||'').trim(); if(!hr) continue;
      const ev = String(m.darsena||'').trim().toUpperCase();
      if(allow.size && !allow.has(ev)) continue;
      const t = String(m.fecha||'');
      const prev = idx[hr] && idx[hr][ev];
      if(!idx[hr]) idx[hr] = {};
      if(!prev || hmToInt(t) >= hmToInt(prev)){ idx[hr][ev] = t; }
    }
    return idx;
  }
  function buildLastEventPlanta(movs){
    const idx = {};
    for(const m of movs){
      const hr = String(m.hr||'').trim(); if(!hr) continue;
      const evName = String(m.darsena||'').trim();
      const t = String(m.fecha||''); // HH:MM
      const prevT = idx[hr] && idx[hr]._t;
      if(!idx[hr] || hmToInt(t) >= hmToInt(prevT)){
        idx[hr] = { name: evName, time: t, _t: t };
      }
    }
    const out = {}; Object.keys(idx).forEach(hr => out[hr] = { name: idx[hr].name || 'â€”', time: idx[hr].time || ''});
    return out;
  }

  /* ================ TABLA ÃšNICA ================ */
  function renderTablaUnica(data){
    const ing = Array.isArray(data.ingresos_esperados)?data.ingresos_esperados:[];
    const sal = (Array.isArray(data.salidas_rows)?data.salidas_rows:[]).filter(r=>String(r.hr||'').trim());
    const plantaRows = Array.isArray(data.en_planta_rows)?data.en_planta_rows:[];

    const movsIng = Array.isArray(data.ingresos_movs)?data.ingresos_movs:[];
    const movsSal = Array.isArray(data.salidas_movs)?data.salidas_movs:[];
    const movsPlt = Array.isArray(data.en_planta_movs)?data.en_planta_movs:[];

    const evIdx = buildEventIndex([].concat(movsIng, movsSal, movsPlt), ['PRESENTADO','SALIDA']);
    const lastPl = buildLastEventPlanta(movsPlt);

    document.getElementById('countIng').textContent = ing.length;
    document.getElementById('countSal').textContent = sal.length;
    document.getElementById('countPlantaMini').textContent = plantaRows.length;

    const rowsHTML = [];

    // Ingresos
    for(const r of ing){
      const hr = String(r.hr||'').trim();
      const hora = r.horariocarga || r.turno || '';
      const ingreso = evIdx[hr]?.['PRESENTADO'] || '';
      const salida  = evIdx[hr]?.['SALIDA'] || '';
      const transp  = r.empresa || r.transporte || '';
      const situTxt = r.estado || '';
      const situCls = situClassByEstado(situTxt);
      rowsHTML.push(`<tr>
        <td>${r.hr||''}</td><td>${r.patente||''}</td><td>${hora}</td><td><b>${r.estado||''}</b></td>
        <td>${r.vuelta||''}</td><td>${r.tipo_viaje||''}</td><td>${r.tipo_equipo||''}</td><td>${r.tipo_zona||''}</td>
        <td>${transp}</td><td>${ingreso}</td><td>${salida}</td>
        <td class="td-situ ${situCls}">${situTxt||'â€”'}</td>
      </tr>`);
    }

    // En planta
    for(const r of plantaRows){
      const hr = String(r.hr||'').trim();
      const hora = r.horariocarga || r.turno || '';
      const ingreso = evIdx[hr]?.['PRESENTADO'] || '';
      const salida  = evIdx[hr]?.['SALIDA'] || '';
      const dock    = (r.darsenaActual || '').toString().toUpperCase();
      const transp  = r.empresa || r.transporte || '';
      const last    = lastPl[hr] || {name:'â€”', time:''};
      const stage   = stageFromEvent(last.name);
      const col     = getDockColor(dock);

      if (stage > 0){
        const st = STAGE_STYLE[stage];
        rowsHTML.push(`<tr class="dock-row" style="--dock-bg:${col.bg};--dock-ink:${col.ink}">
          <td>${r.hr||''}</td><td>${r.patente||''}</td><td>${hora}</td><td><b>En planta</b></td>
          <td>${r.vuelta||''}</td><td>${r.tipo_viaje||''}</td><td>${r.tipo_equipo||''}</td><td>${r.tipo_zona||''}</td>
          <td>${transp}</td><td>${ingreso}</td><td>${salida}</td>
          <td class="td-situ stage-situ" style="--stage-bg:${st.bg};--stage-ink:${st.ink}">${last.name}</td>
        </tr>`);
      }else{
        rowsHTML.push(`<tr class="dock-row" style="--dock-bg:${col.bg};--dock-ink:${col.ink}">
          <td>${r.hr||''}</td><td>${r.patente||''}</td><td>${hora}</td><td><b>En planta</b></td>
          <td>${r.vuelta||''}</td><td>${r.tipo_viaje||''}</td><td>${r.tipo_equipo||''}</td><td>${r.tipo_zona||''}</td>
          <td>${transp}</td><td>${ingreso}</td><td>${salida}</td>
          <td class="td-situ situ-neut">${last.name}</td>
        </tr>`);
      }
    }

    // Salidas confirmadas
    for(const r of sal){
      const hr = String(r.hr||'').trim();
      const horaCarga = r.horariocarga || r.turno || '';
      const presentado = evIdx[hr]?.['PRESENTADO'] || '';
      const salida     = evIdx[hr]?.['SALIDA'] || '';
      const transp     = r.empresa || r.transporte || '';
      const estadoCalc = calcEstadoCarga(horaCarga, presentado);
      const situTxt    = 'Despachado';
      const situCls    = situClassByEstado(estadoCalc || r.estado || '');
      rowsHTML.push(`<tr class="sal-row">
        <td>${r.hr||''}</td><td>${r.patente||''}</td><td>${horaCarga}</td><td><b>${estadoCalc||r.estado||''}</b></td>
        <td>${r.vuelta||''}</td><td>${r.tipo_viaje||''}</td><td>${r.tipo_equipo||''}</td><td>${r.tipo_zona||''}</td>
        <td>${transp}</td><td>${presentado}</td><td>${salida}</td>
        <td class="td-situ ${situCls}">${situTxt}</td>
      </tr>`);
    }

    document.querySelector('#tblMix tbody').innerHTML =
      rowsHTML.join('') || `<tr><td colspan="12" class="muted">Sin datos</td></tr>`;
  }

  /* ================ EN PLANTA (chips) ================ */
  function renderPlanta(data){
    const rows = Array.isArray(data.en_planta_rows)?data.en_planta_rows:[];
    const movs = Array.isArray(data.en_planta_movs)?data.en_planta_movs:[];
    document.getElementById('countPlanta').textContent = rows.length;

    const equipoByHr = {};
    for(const r of rows){ if(r && r.hr) equipoByHr[String(r.hr)] = (r.tipo_equipo||''); }

    // Ãºltimo evento por HR (guardamos tambiÃ©n la hora HH:MM)
    const lastEv = {};
    for (const m of movs){
      const hr = String(m.hr||'').trim(); if(!hr) continue;
      const ev = String(m.darsena||'').trim();
      const t  = String(m.fecha||''); // HH:MM
      const score = hmToInt(t);
      if(!lastEv[hr] || score >= lastEv[hr].score){
        lastEv[hr] = { evento: ev, time: t, score };
      }
    }

    const byDock = Object.create(null);
    for (const r of rows){
      const key = String(r.darsenaActual||'').toUpperCase();
      if(!byDock[key]) byDock[key] = [];
      byDock[key].push(r);
    }

    const chip = (zona, hr, patente, eq, evName, evTimeHHMM)=>{
      const colDock = getDockColor(zona);
      const stage   = stageFromEvent(evName);
      const startEpoch = hhmmToEpoch(evTimeHHMM);
      const timeSpan = `<span class="ago-badge live-ago" data-start="${startEpoch}" data-stage="${stage}" data-zone="${zona}">00:00:00</span>`;
      let line2;
      if (stage > 0){
        const st = STAGE_STYLE[stage];
        line2 = `<span class="stage-pill" style="--stage-bg:${st.bg};--stage-ink:${st.ink}">${(evName||'â€”')}</span> Â· ${timeSpan}`;
      }else{
        line2 = `${(evName||'â€”')} Â· ${timeSpan}`;
      }
      return `
        <div class="chip" data-zona="${zona}" style="background:${colDock.bg};color:${colDock.ink};border-color:${colDock.bg}">
      
          <div class="line1"><b>${hr||''}</b><span class="sep">Â·</span>${patente||''}${eq?`<span class="sep">Â·</span>${eq}`:''}</div>
          <div class="line2">${line2}</div>
        </div>`;
    };

    const combinedNames = ['PRESENTADO','PLAYA','PLAY2'];
    const counts = combinedNames.map(n => (byDock[n]||[]).length);
    const comboItems = combinedNames.flatMap(z =>
      (byDock[z]||[]).map(x=>{
        const evInfo = lastEv[String(x.hr||'')]||{};
        return chip(z, x.hr, x.patente, (equipoByHr[String(x.hr||'')]||''), evInfo.evento, evInfo.time);
      })
    );
    const combo = document.getElementById('plantaCombo');
    combo.querySelector('h4').innerHTML = `
      PRESENTADO <span class="badge">${counts[0]}</span>
      PLAYA <span class="badge">${counts[1]}</span>
      PLAY2 <span class="badge">${counts[2]}</span>`;
    combo.querySelector('.list').innerHTML = comboItems.join('') || `<div class="muted">â€”</div>`;

    const restOrder = ['DOCK1','DOCK2','DOCK3','ALERO','CARPA'];
    const restHTML = restOrder.map(name=>{
      const arr = byDock[name]||[];
      const list = arr.map(x=>{
        const evInfo = lastEv[String(x.hr||'')]||{};
        return chip(name, x.hr, x.patente, (equipoByHr[String(x.hr||'')]||''), evInfo.evento, evInfo.time);
      }).join('') || `<div class="muted">â€”</div>`;
      return `<div class="planta-col"><h4>${name} <span class="badge">${arr.length}</span></h4><div class="list">${list}</div></div>`;
    }).join('');
    document.getElementById('plantaRest').innerHTML = restHTML;

    setupLiveAgoCounters();
  }

  /* ====== Contadores HH:MM:SS en vivo para globos ====== */
  let agoTimer = null;
  function setupLiveAgoCounters(){
    if (agoTimer){ clearInterval(agoTimer); agoTimer=null; }
    const pad = (n)=> (n<10?'0':'')+n;

    const EXCLUDE = new Set(['PRESENTADO','PLAYA','PLAY2']);
    const DOCK_ZONES = new Set(['DOCK1','DOCK2','DOCK3','ALERO','CARPA']);
    const isDock = (zona)=> DOCK_ZONES.has(String(zona||'').toUpperCase());
    const nodes = Array.from(document.querySelectorAll('.live-ago'));

    const tick = ()=>{
      const now = Date.now();
      for (const el of nodes){
        const start = Number(el.dataset.start||0);
        const stage = Number(el.dataset.stage||0);
        const zona  = String(el.dataset.zone||'');
        const zonaUP = zona.toUpperCase();

        if (!start){ el.textContent = '00:00:00'; el.classList.remove('overdue'); continue; }

        let diff = Math.max(0, Math.floor((now - start)/1000));
        const h = Math.floor(diff/3600); diff -= h*3600;
        const m = Math.floor(diff/60);
        const s = diff - m*60;
        el.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;

        const overHour = (now - start) >= 3600*1000;
        const dock     = isDock(zonaUP);
        const shouldRed = !EXCLUDE.has(zonaUP) && overHour && (dock || stage>0);
        if (shouldRed){ el.classList.add('overdue'); } else { el.classList.remove('overdue'); }
      }
    };
    tick();
    agoTimer = setInterval(tick, 1000);
  }

  /* Utils */
  function pad(n){ return (n<10?'0':'')+n; }
  function calcEstadoCarga(horarioCarga, presentado){
    const hc = hmToInt(horarioCarga);
    const pr = hmToInt(presentado);
    if(hc<0 || pr<0) return '';
    return (pr <= hc) ? 'A tiempo' : 'Demorado';
  }
  function hmToInt(txt){
    const m = /(\d{1,2}):(\d{2})/.exec(txt||''); if(!m) return -1;
    return (+m[1])*60 + (+m[2]);
  }
  function hhmmToEpoch(hhmm){
    const m = /(\d{1,2}):(\d{2})/.exec(hhmm||'');
    const now = new Date();
    if (!m){ return now.getTime(); }
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), +m[1], +m[2], 0, 0);
    if (d.getTime() > now.getTime()) d.setDate(d.getDate()-1); // si quedÃ³ a futuro, fue ayer
    return d.getTime();
  }

  // Inicializaciones
  document.addEventListener('DOMContentLoaded', () => {
    const badge = document.getElementById('countPlanta');
    if (badge){
      const h3 = badge.closest('h3');
      if (h3) h3.classList.add('h3-planta');
    }
    updateFSUI(); // sincroniza estado inicial del botÃ³n
  });

  (function initTheme(){
    const light = localStorage.getItem('themeLight') === '1';
    if (light) document.body.classList.add('light');
  })();
 // Fuerza zoom a p (0.6 = 60%). Usa 'zoom' si existe; si no, usa transform.
  function forceZoom(p = 0.6){
    try{
      // Intento 1: propiedad 'zoom' nativa (Chromium/Tizen recientes)
      if (window.CSS && CSS.supports && CSS.supports('zoom', String(p))){
        document.body.style.zoom = p;            // 0.6
        document.documentElement.style.zoom = p; // por si el body no basta
        return;
      }
    }catch(_){/* ignore */}

    // Fallback: escala por transform
    document.documentElement.style.setProperty('--appScale', String(p));
    document.body.classList.add('scaled');
  }

  // Llamalo al cargar la pÃ¡gina:
  document.addEventListener('DOMContentLoaded', ()=> forceZoom(0.6));
  startClockPlanta();
  loadData();
</script>
</body>
</html>
